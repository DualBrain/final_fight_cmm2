'-- SOUND SUB SYSTEM --
DIM SFX_P(5)


'-- PLAY BACKGROUND MUSIC AS WAVE --
SUB PLAY_WAV(MUS$,P)
 PLMUS$="./MUSIC/"+MUS$+".WAV"
 IF MM.INFO(SOUND)="MODFILE" AND BGM THEN
  IF P=0 THEN PLAY EFFECT PLMUS$,LOOP_MUS ELSE PLAY EFFECT PLMUS$
 ENDIF
END SUB


'-- LOOP MUSIC --
SUB LOOP_MUS
 IF MM.INFO(SOUND)="MODFILE" AND BGM THEN PLAY EFFECT PLMUS$,LOOP_MUS
END SUB


'-- CHANGE LOOP MUSIC TO BE PLAYED AFTER --
SUB CHANGE_LOOP_MUS(MUS$)
 PLMUS$="./MUSIC/"+MUS$+".WAV"
END SUB


'-- PLAY A SAMPLE "N" WITH "F" FREQUENCY IN CHANNEL C (TO SIMULATE THE ORIGINAL ARCADE) --
'-- IF PR<>0 THEN DON'T PLAY SOUND IF ALREADY IN USE
SUB PLAY_SAMPLE N,C,F,PR
 LOCAL T
 FOR T=1 TO 4
  IF MM.INFO(SAMPLE PLAYING T) = 0 THEN SFX_P(T)=0
 NEXT T
 IF F=0 THEN F=22050
 IF PR<SFX_P(C) AND MM.INFO(SAMPLE PLAYING C) > 0 THEN EXIT SUB
 SFX_P(C)=PR 
 PLAY MODSAMPLE N,C,64,F
END SUB


'-- SEARCH FOR DISPONIBLE CHANNEL AND PLAY A SAMPLE "N" WITH "F" FREQUENCY--
SUB PLAY_SAMPLE_FIFO N,F,V,PR
 LOCAL T,PLAYED

 IF V=0 THEN V=64

 FOR T=1 TO 4
  IF MM.INFO(SAMPLE PLAYING T) = 0 THEN SFX_P(T)=0
 NEXT T

 FOR T=1 TO 4
  INC SFX_N: IF SFX_N>4 THEN SFX_N=1
  IF MM.INFO(SAMPLE PLAYING SFX_N) = 0 OR PR >= SFX_P(SFX_N) THEN
   IF PR=0 THEN SFX_P(T)=0
   PLAYED=1
   PLAY MODSAMPLE N,SFX_N,V,F
   EXIT FOR
  ENDIF
 NEXT T

 'FORCE TO PLAY TO THE FIRST CHANNEL IN THE FIFO
 IF PLAYED=0 THEN
  FOR T=1 TO 4
   INC SFX_N: IF SFX_N>4 THEN SFX_N=1
  NEXT T
  PLAY MODSAMPLE N,SFX_N,V,F
 ENDIF 
END SUB



